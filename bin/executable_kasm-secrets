#!/bin/bash
set -euo pipefail


# Configuration
TARGET_SECRETS_FILE="$HOME/dotfiles/.chezmoidata/kasm_secrets.yml"

# Edit this template to add/remove secrets
generate_config() {
    local output_file="$1"

    # Don't add quotes around fetch_secret below.
    # fetch_secrets returns strings from Bitwarden that *include double quotes*.
    # Those quotes will be written to the YAML below to quote the string.
    cat <<EOF > "$output_file"
# Mike Kasberg's Dotfiles Secrets
#
# This file is installed and managed by the kasm-secrets script.
# Check if secrets are installed in Chezmoi templates with {{ if hasKey . "kasm_secrets" }}.
# Reference secrets like {{ .kasm_secrets.foo.bar }}.
#
# DO NOT commit this file to git.

kasm_secrets:
  ssh:
    nfs_user: $(fetch_secret 'd0288e58-57d0-425f-9222-ab9901367767' '.notes')
    csysk_user: $(fetch_secret '5bceb80e-b91a-40f5-98b6-ab9901369978' '.notes')
    id_rsa: $(fetch_secret '13ba82c4-94f8-44ff-8bc1-ab99013879b9' '.notes')
    kas_catholic_id_rsa: $(fetch_secret '7020a3af-11aa-4a78-9e98-ade7002b86f2' '.notes')
  borg:
    passphrase: $(fetch_secret 'abe61755-1417-44f6-90f7-aba8018a5b6c' '.notes')
EOF
}

usage() {
    echo "Usage: $(basename "$0") [install|diff|help]"
    echo ""
    echo "Commands:"
    echo "  install   (default) Fetch secrets and write to target file."
    echo "  diff      Fetch secrets and show diff against existing target file."
    echo "  help      Show this help message."
}

log_info() {
    echo -e "ℹ️  $1" >&2
}

log_success() {
    echo -e "✅  $1" >&2
}

log_error() {
    echo -e "❌  $1" >&2
}

check_deps() {
    local missing_deps=0
    for dep in bw jq; do
        if ! command -v "$dep" &> /dev/null; then
            log_error "Missing dependency: $dep"
            missing_deps=1
        fi
    done
    if [ "$missing_deps" -ne 0 ]; then
        exit 1
    fi
}

# Fetch secret note. Preserves original behavior (including quotes from jq output).
fetch_secret() {
    log_info "Fetching Bitwarden item $1..."
    bw get item "$1" | jq "$2"
}

main() {
    local cmd="${1:-install}"

    case "$cmd" in
        help|-h|--help)
            usage
            exit 0
            ;;
        install|diff)
            ;;
        *)
            usage
            exit 1
            ;;
    esac

    check_deps

    # Create a temporary file
    local temp_file
    temp_file=$(mktemp)

    # Ensure temp file is cleaned up on exit
    trap "rm -f '$temp_file'" EXIT

    # Generate content
    generate_config "$temp_file"

    if [ "$cmd" = "diff" ]; then
        if [ -f "$TARGET_SECRETS_FILE" ]; then
            log_info "Diffing against $TARGET_SECRETS_FILE:"
            if diff -u "$TARGET_SECRETS_FILE" "$temp_file"; then
                log_success "Up to date: $TARGET_SECRETS_FILE"
            fi
        else
            log_info "Target file does not exist. Content would be:"
            cat "$temp_file"
        fi
    elif [ "$cmd" = "install" ]; then
        mkdir -p "$(dirname "$TARGET_SECRETS_FILE")"
        mv "$temp_file" "$TARGET_SECRETS_FILE"
        chmod 600 "$TARGET_SECRETS_FILE"
        log_success "Secrets installed to $TARGET_SECRETS_FILE"
    fi
}

main "$@"
